<!DOCTYPE html><html lang="en"><head><title>src/both/time</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="src/both/time"><meta name="groc-project-path" content="src/both/time.js"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/both/time.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="time">time</h1>

<p>All things time. Uses <a href="http://momentjs.com/">Moment</a> and <a href="https://github.com/mde/timezone-js">TimezoneJS</a>
to present a number of simple time-related methods.</p>

<p>On the server side, timezone-related functionality requires one environment variable:
TIME_ZONE_DATA, where you've put your <code>all.json</code> parsed and minified time zone
data file.</p>

<p>NOTE: To use this module in the browser you'll need to specify paths for three
components in your requirejs config: <code>moment</code>, <code>timezone-js</code> and <code>fs</code>. <code>fs</code>
can be set to an empty placeholder module (like <a href="../client/js/shims/empty.html"><code>empty</code></a>)
since it's not used on the client side. Additionally, because <code>timezone-js</code>
is not aware of AMD loaders, you'll need to put this
in your requirejs shims section:</p>

<pre><code>'timezone-js': {
  init: function() {
    return window.timezoneJS;
  }
}
</code></pre>

<p>Lastly, <code>timezone-js</code> requires Fleegix, jQuery or Zepto to load a timezone data
file via AJAX.</p>

<p>NOTE: In this file, when we talk about times being in the <em>default timezone</em>,
we mean that they are "correct", the right UTC time. When they are "in a
local timezone" they are no longer correct, and should not be used for anything
but display. They have been shifted so as to be printed out correctly, but their
UTC values are are no longer correct.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><a href="http://requirejs.org/">RequireJS</a> boilerplate, dependencies and
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions_and_function_scope/Strict_mode">strict mode</a></p></div></div><div class="code"><div class="wrapper"><span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">define</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">define</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;amdefine&#39;</span><span class="p">)(</span><span class="nx">module</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">define</span><span class="p">([</span><span class="s1">&#39;moment&#39;</span><span class="p">,</span> <span class="s1">&#39;winston&#39;</span><span class="p">,</span> <span class="s1">&#39;util&#39;</span><span class="p">,</span> <span class="s1">&#39;fs&#39;</span><span class="p">,</span> <span class="s1">&#39;timezone-js&#39;</span><span class="p">,</span> <span class="s1">&#39;./string&#39;</span><span class="p">],</span>
  <span class="kd">function</span><span class="p">(</span><span class="nx">moment</span><span class="p">,</span> <span class="nx">winston</span><span class="p">,</span> <span class="nx">util</span><span class="p">,</span> <span class="nx">fs</span><span class="p">,</span> <span class="nx">timezonejs</span><span class="p">,</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="s1">&#39;use strict&#39;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="setup">Setup</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>In the browser we synchronously load timezone data from <code>window.tzUrl</code>.</p></div></div><div class="code"><div class="wrapper">  <span class="kd">var</span> <span class="nx">tz</span> <span class="o">=</span> <span class="nx">timezonejs</span><span class="p">.</span><span class="nx">timezone</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">tzUrl</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">winston</span><span class="p">.</span><span class="nx">verbose</span><span class="p">(</span><span class="s1">&#39;JSON file containing time zone data was not specified via window.tzUrl&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">tz</span><span class="p">.</span><span class="nx">loadingScheme</span> <span class="o">=</span> <span class="nx">tz</span><span class="p">.</span><span class="nx">loadingSchemes</span><span class="p">.</span><span class="nx">MANUAL_LOAD</span><span class="p">;</span>
      <span class="c1">//true here signifies that we want to load the JSON synchronously</span>
      <span class="nx">tz</span><span class="p">.</span><span class="nx">loadZoneJSONData</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">tzUrl</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>On the server we load timezone data at the TIME_ZONE_DATA environment variable.
We use a synchronous filesystem load to avoid race conditions.</p></div></div><div class="code"><div class="wrapper">  <span class="k">else</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tzPath</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">TIME_ZONE_DATA</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">tzPath</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">winston</span><span class="p">.</span><span class="nx">verbose</span><span class="p">(</span><span class="s1">&#39;JSON file containing time zone data was not specified via TIME_ZONE_DATA environment variable&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">tz</span><span class="p">.</span><span class="nx">loadingScheme</span> <span class="o">=</span> <span class="nx">tz</span><span class="p">.</span><span class="nx">loadingSchemes</span><span class="p">.</span><span class="nx">PRELOAD_ALL</span><span class="p">;</span>
      <span class="nx">tz</span><span class="p">.</span><span class="nx">zoneFileBasePath</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">TIME_ZONE_DATA</span><span class="p">;</span>
      <span class="nx">tz</span><span class="p">.</span><span class="nx">transport</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
      <span class="p">};</span>
      <span class="nx">tz</span><span class="p">.</span><span class="nx">init</span><span class="p">({</span><span class="nx">async</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="duration">Duration</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The <code>time.Duration</code> class helps keep track of a span of time.
Create a new instance of the class, then use the result of <code>duration.end()</code>
in your logs to get the amount of time elapsed.</p></div></div><div class="code"><div class="wrapper">  <span class="kd">function</span> <span class="nx">Duration</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>end</code> can return the raw milliseconds elapsed if <code>render</code> is set to false.
Otherwise it renders that milliseconds number with <code>time.renderTimespan</code>.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">Duration</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">end</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">render</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">render</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">render</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">end</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">getTime</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">render</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">time</span><span class="p">.</span><span class="nx">renderTimespan</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">result</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">time</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Duration</span><span class="o">:</span> <span class="nx">Duration</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="date-formatting">Date Formatting</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>easyLong</code> produces strings like 'Friday July 26 at 8:15am', or
'Friday July 26 2012 at 8:15am' if the year is different from
the current year.</p>

<p>If you pass in a <code>timezone</code>, the <code>date</code> passed
in is assumed to be in the <em>default timezone</em>.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">easyLong</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">timezone</span><span class="p">,</span> <span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">now</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">date</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">timezone</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">date</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">toTimezone</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">timezone</span><span class="p">);</span>
        <span class="nx">now</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">toTimezone</span><span class="p">(</span><span class="nx">now</span><span class="p">,</span> <span class="nx">timezone</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">()</span> <span class="o">===</span> <span class="nx">now</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">moment</span><span class="p">(</span><span class="nx">date</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="s1">&#39;dddd MMM D [at] h:mma&#39;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">moment</span><span class="p">(</span><span class="nx">date</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="s1">&#39;dddd MMM D YYYY [at] h:mma&#39;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>shortDate</code> produces strings like 'July 1' or 'July 1 2012' if
the year is different from the current year.</p>

<p>If you pass in a <code>timezone</code>, the <code>date</code> passed
in is assumed to be in the <em>default timezone</em>.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">shortDate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">timezone</span><span class="p">,</span> <span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">now</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">date</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">timezone</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">date</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">toTimezone</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">timezone</span><span class="p">);</span>
        <span class="nx">now</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">toTimezone</span><span class="p">(</span><span class="nx">now</span><span class="p">,</span> <span class="nx">timezone</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">()</span> <span class="o">===</span> <span class="nx">now</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">moment</span><span class="p">(</span><span class="nx">date</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="s1">&#39;MMM D&#39;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">moment</span><span class="p">(</span><span class="nx">date</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="s1">&#39;MMM D YYYY&#39;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>dayOfWeek</code> produces the full, capitalized day of the week.</p>

<p>If you pass in a <code>timezone</code>, the <code>date</code> passed
in is assumed to be in the <em>default timezone</em>.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">dayOfWeek</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">timezone</span><span class="p">,</span> <span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">date</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">timezone</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">date</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">toTimezone</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">timezone</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">moment</span><span class="p">(</span><span class="nx">date</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="s1">&#39;dddd&#39;</span><span class="p">);</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>parse</code> tries to generate a date from the provided <code>text</code>, <code>timezone</code>
and <code>now</code> (base time). 'today', 'tomorrow' and 'yesterday' are accepted, and fully
qualified dates are supported <a href="http://momentjs.com/docs/#/parsing/string/">by Moment</a>.
If the date cannot be parsed, this method will return <code>null</code>.</p>

<p>If you pass in a <code>timezone</code>, the returned date will in the <em>default timezone</em>.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">timezone</span><span class="p">,</span> <span class="nx">now</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">now</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">now</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;today&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">now</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;tomorrow&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">now</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="nx">time</span><span class="p">.</span><span class="nx">DAY_IN_MIL</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;yesterday&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">now</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="nx">time</span><span class="p">.</span><span class="nx">DAY_IN_MIL</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">momentParsed</span> <span class="o">=</span> <span class="nx">moment</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">momentParsed</span><span class="p">.</span><span class="nx">isValid</span><span class="p">())</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">momentParsed</span><span class="p">.</span><span class="nx">toDate</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">timezone</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">result</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">fromTimezone</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">timezone</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>englishTimespan</code> produces an easily human-readable phrase describing the amount
of time described by <code>mil</code> milliseconds. It produces basic strings like
"30 seconds" or "2 hours", never including anything but the biggest unit.
The next step after "1 hour" is "2 hours", nothing in between.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">englishTimespan</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">mil</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">mil</span> <span class="o">&lt;</span> <span class="nx">time</span><span class="p">.</span><span class="nx">SECOND_IN_MIL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;now&#39;</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">steps</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="nx">divisor</span><span class="o">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">SECOND_IN_MIL</span><span class="p">,</span> <span class="nx">single</span><span class="o">:</span> <span class="s1">&#39;second&#39;</span><span class="p">,</span> <span class="nx">plural</span><span class="o">:</span> <span class="s1">&#39;seconds&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="nx">divisor</span><span class="o">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">MINUTE_IN_MIL</span><span class="p">,</span> <span class="nx">single</span><span class="o">:</span> <span class="s1">&#39;minute&#39;</span><span class="p">,</span> <span class="nx">plural</span><span class="o">:</span> <span class="s1">&#39;minutes&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="nx">divisor</span><span class="o">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">HOUR_IN_MIL</span><span class="p">,</span> <span class="nx">single</span><span class="o">:</span> <span class="s1">&#39;hour&#39;</span><span class="p">,</span> <span class="nx">plural</span><span class="o">:</span> <span class="s1">&#39;hours&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="nx">divisor</span><span class="o">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">DAY_IN_MIL</span><span class="p">,</span> <span class="nx">single</span><span class="o">:</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="nx">plural</span><span class="o">:</span> <span class="s1">&#39;days&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="nx">divisor</span><span class="o">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">WEEK_IN_MIL</span><span class="p">,</span> <span class="nx">single</span><span class="o">:</span> <span class="s1">&#39;week&#39;</span><span class="p">,</span> <span class="nx">plural</span><span class="o">:</span> <span class="s1">&#39;weeks&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="nx">divisor</span><span class="o">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">MONTH_IN_MIL</span><span class="p">,</span> <span class="nx">single</span><span class="o">:</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="nx">plural</span><span class="o">:</span> <span class="s1">&#39;months&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="nx">divisor</span><span class="o">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">DAY_IN_MIL</span> <span class="o">*</span> <span class="mi">365</span><span class="p">,</span> <span class="nx">single</span><span class="o">:</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="nx">plural</span><span class="o">:</span> <span class="s1">&#39;years&#39;</span><span class="p">}</span>
      <span class="p">];</span>

      <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">step</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">units</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">mil</span> <span class="o">/</span> <span class="nx">steps</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">divisor</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">mil</span> <span class="o">/</span> <span class="nx">steps</span><span class="p">[</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="nx">divisor</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">next</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">index</span> <span class="o">=</span> <span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
          <span class="k">return</span> <span class="nx">step</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">string</span><span class="p">.</span><span class="nx">pluralize</span><span class="p">(</span><span class="nx">units</span><span class="p">,</span> <span class="nx">steps</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">single</span><span class="p">,</span> <span class="nx">steps</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">plural</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">};</span>

      <span class="k">return</span> <span class="nx">step</span><span class="p">();</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>renderTimespan</code> formats <code>mil</code> milliseconds as a human-readable
time string, like ":02.031" (two seconds and 31 milliseconds)
or "4:00" (four minutes). Milliseconds will not be shown unless
<code>withMil</code> is truthy and the timespan is under one minute.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">renderTimespan</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">mil</span><span class="p">,</span> <span class="nx">withMil</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">hours</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">mil</span> <span class="o">/</span> <span class="nx">time</span><span class="p">.</span><span class="nx">HOUR_IN_MIL</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">hours</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">+=</span> <span class="nx">hours</span><span class="p">;</span>
        <span class="nx">result</span> <span class="o">+=</span> <span class="s1">&#39;:&#39;</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">mil</span> <span class="o">-=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">HOUR_IN_MIL</span> <span class="o">*</span> <span class="nx">hours</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">minutes</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">mil</span> <span class="o">/</span> <span class="nx">time</span><span class="p">.</span><span class="nx">MINUTE_IN_MIL</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">hours</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">+=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">addPadding</span><span class="p">(</span><span class="nx">minutes</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">minutes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">+=</span> <span class="nx">minutes</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">mil</span> <span class="o">-=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">MINUTE_IN_MIL</span> <span class="o">*</span> <span class="nx">minutes</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">seconds</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">mil</span> <span class="o">/</span> <span class="nx">time</span><span class="p">.</span><span class="nx">SECOND_IN_MIL</span><span class="p">);</span>
      <span class="nx">result</span> <span class="o">+=</span> <span class="s1">&#39;:&#39;</span><span class="p">;</span>
      <span class="nx">result</span> <span class="o">+=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">addPadding</span><span class="p">(</span><span class="nx">seconds</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">withMil</span> <span class="o">&amp;&amp;</span> <span class="nx">hours</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">minutes</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">mil</span> <span class="o">-=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">SECOND_IN_MIL</span> <span class="o">*</span> <span class="nx">seconds</span><span class="p">;</span>
        <span class="nx">result</span> <span class="o">+=</span> <span class="s1">&#39;.&#39;</span><span class="p">;</span>
        <span class="nx">result</span> <span class="o">+=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">addPadding</span><span class="p">(</span><span class="nx">mil</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="timezone-manipulation">Timezone Manipulation</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>toTimezone</code> takes a <code>date</code> and a <code>timezone</code>, converting the provided date
to the new timezone from the <em>default timezone</em>. Useful in rendering times
in the user's timezone on a server.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">toTimezone</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">timezone</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">source</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">timezonejs</span><span class="p">.</span><span class="nb">Date</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">());</span>
      <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">timezonejs</span><span class="p">.</span><span class="nb">Date</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">(),</span> <span class="nx">timezone</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span>
        <span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">getTimezoneOffset</span><span class="p">()</span> <span class="o">-</span> <span class="nx">target</span><span class="p">.</span><span class="nx">getTimezoneOffset</span><span class="p">())</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">MINUTE_IN_MIL</span><span class="p">);</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>fromTimezone</code> takes a <code>date</code> and a <code>timezone</code>, converting the provided
date to the <em>default timezone</em>, assuming that <code>date</code> was previously in
the provided <code>timezone</code>.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">fromTimezone</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">timezone</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">source</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">timezonejs</span><span class="p">.</span><span class="nb">Date</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">(),</span> <span class="nx">timezone</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">timezonejs</span><span class="p">.</span><span class="nb">Date</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">());</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span>
        <span class="p">(</span><span class="nx">target</span><span class="p">.</span><span class="nx">getTimezoneOffset</span><span class="p">()</span> <span class="o">-</span> <span class="nx">source</span><span class="p">.</span><span class="nx">getTimezoneOffset</span><span class="p">())</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">MINUTE_IN_MIL</span><span class="p">);</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>timezoneAwareDate</code> is a wrapper around the instantiation of a new
<code>timezoneJS.Date</code>.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">timezoneAwareDate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">timezone</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">timezonejs</span><span class="p">.</span><span class="nb">Date</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">(),</span> <span class="nx">timezone</span><span class="p">);</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>getTimezone</code> looks up the current timezone. Because timezonejs doesn't
have a reverse timezone lookup function, we set up a reverse lookup table
first:</p>

<p><em>TODO: Build this reverse lookup table from timezone data itself.</em></p></div></div><div class="code"><div class="wrapper">    <span class="nx">getTimezone</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">time</span><span class="p">.</span><span class="nx">timezoneLookup</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="nx">t</span><span class="p">[</span><span class="o">-</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Pacific/Pago_Pago&#39;</span><span class="p">];</span>
        <span class="nx">t</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;US/Hawaii&#39;</span><span class="p">,</span> <span class="s1">&#39;US/Aleutian&#39;</span><span class="p">];</span>
        <span class="nx">t</span><span class="p">[</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;US/Aleutian&#39;</span><span class="p">,</span> <span class="s1">&#39;Pacific/Gambier&#39;</span><span class="p">,</span> <span class="s1">&#39;US/Alaska&#39;</span><span class="p">];</span>
        <span class="nx">t</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;US/Pacific&#39;</span><span class="p">,</span> <span class="s1">&#39;US/Alaska&#39;</span><span class="p">,</span> <span class="s1">&#39;Pacific/Pitcairn&#39;</span><span class="p">];</span>
        <span class="nx">t</span><span class="p">[</span><span class="o">-</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;US/Mountain&#39;</span><span class="p">,</span> <span class="s1">&#39;US/Pacific&#39;</span><span class="p">,</span> <span class="s1">&#39;US/Arizona&#39;</span><span class="p">];</span>
        <span class="nx">t</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;US/Central&#39;</span><span class="p">,</span> <span class="s1">&#39;US/Mountain&#39;</span><span class="p">,</span> <span class="s1">&#39;America/Costa_Rica&#39;</span><span class="p">];</span>
        <span class="nx">t</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;US/Eastern&#39;</span><span class="p">,</span> <span class="s1">&#39;US/Central&#39;</span><span class="p">,</span> <span class="s1">&#39;EST&#39;</span><span class="p">];</span>
        <span class="nx">t</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;US/Eastern&#39;</span><span class="p">,</span> <span class="s1">&#39;Brazil/West&#39;</span><span class="p">,</span> <span class="s1">&#39;Canada/Atlantic&#39;</span><span class="p">];</span>
        <span class="nx">t</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Canada/Atlantic&#39;</span><span class="p">,</span> <span class="s1">&#39;Atlantic/Stanley&#39;</span><span class="p">,</span> <span class="s1">&#39;Brazil/East&#39;</span><span class="p">];</span>
        <span class="nx">t</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Brazil/East&#39;</span><span class="p">,</span> <span class="s1">&#39;America/Noronha&#39;</span><span class="p">];</span>
        <span class="nx">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Atlantic/Cape_Verde&#39;</span><span class="p">,</span> <span class="s1">&#39;Atlantic/Azores&#39;</span><span class="p">];</span>
        <span class="nx">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Europe/London&#39;</span><span class="p">,</span> <span class="s1">&#39;UTC&#39;</span><span class="p">,</span> <span class="s1">&#39;Atlantic/Azores&#39;</span><span class="p">];</span>
        <span class="nx">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Europe/London&#39;</span><span class="p">,</span> <span class="s1">&#39;Europe/Rome&#39;</span><span class="p">,</span> <span class="s1">&#39;Africa/Algiers&#39;</span><span class="p">];</span>
        <span class="nx">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Europe/Rome&#39;</span><span class="p">,</span> <span class="s1">&#39;Africa/Cairo&#39;</span><span class="p">,</span> <span class="s1">&#39;Europe/Istanbul&#39;</span><span class="p">];</span>
        <span class="nx">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Europe/Istanbul&#39;</span><span class="p">,</span> <span class="s1">&#39;Africa/Asmara&#39;</span><span class="p">];</span>
        <span class="nx">t</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Asia/Dubai&#39;</span><span class="p">,</span> <span class="s1">&#39;Asia/Baku&#39;</span><span class="p">];</span>
        <span class="nx">t</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Asia/Baku&#39;</span><span class="p">,</span> <span class="s1">&#39;Indian/Maldives&#39;</span><span class="p">];</span>
        <span class="nx">t</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Asia/Almaty&#39;</span><span class="p">];</span>
        <span class="nx">t</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Asia/Bangkok&#39;</span><span class="p">];</span>
        <span class="nx">t</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Australia/West&#39;</span><span class="p">];</span>
        <span class="nx">t</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Asia/Tokyo&#39;</span><span class="p">];</span>
        <span class="nx">t</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Australia/Sydney&#39;</span><span class="p">,</span> <span class="s1">&#39;Pacific/Guam&#39;</span><span class="p">];</span>
        <span class="nx">t</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Australia/Sydney&#39;</span><span class="p">,</span> <span class="s1">&#39;Asia/Vladivostok&#39;</span><span class="p">];</span>
        <span class="nx">t</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Pacific/Auckland&#39;</span><span class="p">,</span> <span class="s1">&#39;Asia/Kamchatka&#39;</span><span class="p">];</span>
        <span class="nx">t</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Pacific/Auckland&#39;</span><span class="p">,</span> <span class="s1">&#39;Pacific/Enderbury&#39;</span><span class="p">];</span>
        <span class="nx">t</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Pacific/Kiritimati&#39;</span><span class="p">];</span>

        <span class="nx">time</span><span class="p">.</span><span class="nx">timezoneLookup</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
      <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Then we go through the potential timezones, changing the current
date to that timezone to see if it is changed. If it didn't change,
it'll work!</p></div></div><div class="code"><div class="wrapper">      <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">tzDate</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">timezonejs</span><span class="p">.</span><span class="nb">Date</span><span class="p">(</span><span class="nx">date</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">offsetHours</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="nx">tzDate</span><span class="p">.</span><span class="nx">getTimezoneOffset</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">timezones</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">timezoneLookup</span><span class="p">[</span><span class="nx">offsetHours</span><span class="p">];</span>

      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">timezones</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">z</span> <span class="o">=</span> <span class="nx">timezones</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">offsetDate</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">toTimezone</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">z</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">offsetDate</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">===</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">())</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">z</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="date-manipulation">Date Manipulation</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>now</code> returns the current time. Mostly useful to allow for dependency
injection while unit testing.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">now</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>offset</code> just adds <code>milliseconds</code> to either the <code>date</code> you provide
or the current date, and returns a new <code>Date</code> object.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">offset</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">milliseconds</span><span class="p">,</span> <span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">date</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">millis</span> <span class="o">=</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="nx">milliseconds</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">millis</span><span class="p">);</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>nextDay</code> looks for the next instance of <code>day</code>, where day is something like 'Monday.'
You can set the start <code>date</code> for the search; otherwise it will use the current time.
<code>timezone</code> is required to ensure our determination of the day is correct in the
user's timezone.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">nextDay</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">day</span><span class="p">,</span> <span class="nx">timezone</span><span class="p">,</span> <span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">searchDay</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">day</span><span class="p">,</span> <span class="nx">timezone</span><span class="p">,</span> <span class="nx">date</span><span class="p">);</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>lastDay</code> is exactly like <code>nextDay</code>; it just searches in the opposite direction.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">lastDay</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">day</span><span class="p">,</span> <span class="nx">timezone</span><span class="p">,</span> <span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">searchDay</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">day</span><span class="p">,</span> <span class="nx">timezone</span><span class="p">,</span> <span class="nx">date</span><span class="p">);</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>searchDay</code> does the day searching for <code>nextDay</code> and <code>lastDay</code>.</p>

<p><em>TODO: Think about doing this without basic iteration. Could do it with
math and indices.</em></p></div></div><div class="code"><div class="wrapper">    <span class="nx">searchDay</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">direction</span><span class="p">,</span> <span class="nx">day</span><span class="p">,</span> <span class="nx">timezone</span><span class="p">,</span> <span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
      <span class="cm">/*jshint maxcomplexity: 8 */</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">time</span><span class="p">.</span><span class="nx">daysLookup</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">time</span><span class="p">.</span><span class="nx">daysLookup</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">sunday</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
          <span class="nx">monday</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="nx">tuesday</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
          <span class="nx">wednesday</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
          <span class="nx">thursday</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
          <span class="nx">friday</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
          <span class="nx">saturday</span><span class="o">:</span> <span class="mi">6</span>
        <span class="p">};</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">date</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">timezone</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">timezonejs</span><span class="p">.</span><span class="nb">Date</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">(),</span> <span class="nx">timezone</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">daysLookup</span><span class="p">[</span><span class="nx">day</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()];</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">index</span> <span class="o">&amp;&amp;</span> <span class="nx">index</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">while</span> <span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getDay</span><span class="p">()</span> <span class="o">!==</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">date</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">offset</span><span class="p">(</span><span class="nx">direction</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">DAY_IN_MIL</span><span class="p">,</span> <span class="nx">date</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">timezone</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">timezonejs</span><span class="p">.</span><span class="nb">Date</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">(),</span> <span class="nx">timezone</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">timezone</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">());</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">date</span><span class="p">;</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>toMidnight</code> returns midnight of the day provided, in the target
<code>timezone</code>. <code>date</code> is optional, but assumed to be in the <em>default
timezone</em> if provided.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">toMidnight</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">timezone</span><span class="p">,</span> <span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">time</span><span class="p">.</span><span class="nx">toHour</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">timezone</span><span class="p">,</span> <span class="nx">date</span><span class="p">);</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>toHour</code> truncates the current time or <code>date</code> at hour <code>hour</code> in the
provided <code>timezone</code>. <code>date</code> is optional, but assumed to be in the <em>default
timezone</em> if provided.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">toHour</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">hour</span><span class="p">,</span> <span class="nx">timezone</span><span class="p">,</span> <span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">date</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="nx">date</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">timezoneAwareDate</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">timezone</span><span class="p">);</span>
      <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">timezonejs</span><span class="p">.</span><span class="nb">Date</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">(),</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">(),</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getDate</span><span class="p">(),</span> <span class="nx">hour</span><span class="p">,</span> <span class="nx">timezone</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">());</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>toFirstOfMonth</code> returns the date of the first of the current month
for now or the provided <code>date</code>.<code>date</code> is optional, but assumed to be
in the <em>default timezone</em> if provided.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">toFirstOfMonth</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">timezone</span><span class="p">,</span> <span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">date</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="nx">date</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">timezoneAwareDate</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">timezone</span><span class="p">);</span>
      <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">timezonejs</span><span class="p">.</span><span class="nb">Date</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">(),</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">timezone</span><span class="p">);</span>

      <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">());</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>isLastDayOfMonth</code> tells you whether it's the last of the current month
for now or the provided <code>date</code>.<code>date</code> is optional, but assumed to be in
the <em>default timezone</em> if provided.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">isLastDayOfMonth</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">timezone</span><span class="p">,</span> <span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">date</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">nextDay</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">valueOf</span><span class="p">()</span> <span class="o">+</span> <span class="nx">time</span><span class="p">.</span><span class="nx">DAY_IN_MIL</span><span class="p">);</span>
      <span class="nx">nextDay</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">timezoneAwareDate</span><span class="p">(</span><span class="nx">nextDay</span><span class="p">,</span> <span class="nx">timezone</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">nextDay</span><span class="p">.</span><span class="nx">getDate</span><span class="p">()</span> <span class="o">===</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="other">Other</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><code>addPadding</code> takes an integer and a number of <code>digits</code>, adding leading
zeros to the string until it gets to the desired length.</p>

<p><em>TODO: Doesn't currently handle negative numbers</em></p></div></div><div class="code"><div class="wrapper">    <span class="nx">addPadding</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">number</span><span class="p">,</span> <span class="nx">digits</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">number</span><span class="p">,</span> <span class="mi">10</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="nx">digits</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">digits</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="nx">result</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Useful constants</p></div></div><div class="code"><div class="wrapper">  <span class="nx">time</span><span class="p">.</span><span class="nx">SECOND_IN_MIL</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
  <span class="nx">time</span><span class="p">.</span><span class="nx">MINUTE_IN_MIL</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">SECOND_IN_MIL</span> <span class="o">*</span> <span class="mi">60</span><span class="p">;</span>
  <span class="nx">time</span><span class="p">.</span><span class="nx">HOUR_IN_MIL</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">MINUTE_IN_MIL</span> <span class="o">*</span> <span class="mi">60</span><span class="p">;</span>
  <span class="nx">time</span><span class="p">.</span><span class="nx">DAY_IN_MIL</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">HOUR_IN_MIL</span> <span class="o">*</span> <span class="mi">24</span><span class="p">;</span>
  <span class="nx">time</span><span class="p">.</span><span class="nx">WEEK_IN_MIL</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">DAY_IN_MIL</span> <span class="o">*</span> <span class="mi">7</span><span class="p">;</span>
  <span class="nx">time</span><span class="p">.</span><span class="nx">MONTH_IN_MIL</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">DAY_IN_MIL</span> <span class="o">*</span> <span class="mi">30</span><span class="p">;</span>
  <span class="nx">time</span><span class="p">.</span><span class="nx">YEAR_IN_MIL</span> <span class="o">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">DAY_IN_MIL</span> <span class="o">*</span> <span class="mi">365</span><span class="p">;</span>

  <span class="k">return</span> <span class="nx">time</span><span class="p">;</span>
<span class="p">});</span></div></div></div></div></body></html>