/*
# time
All things time. Uses [Moment](http://momentjs.com/) and
[TimezoneJS](https://github.com/mde/timezone-js) to present a number of simple
time-related methods.

__Server__: On the server side, timezone data is loaded from either 'dist/tz' or a
directory you specify with the TIME\_ZONE\_DATA environment variable.

__Browser__: To make browser usage easier, this project has a
[grunt task](../../Gruntfile.html) which injects time zone data into the file itself.
_NOTE: If you don't end up using one of these versions of 'thehelp-core', `timezone-js`
will need to use AJAX to pull in time zone data. This will require Fleegix, jQuery or
Zepto as well as `window.tzUrl` set to the location of the JSON file containing timezone
info._

__NOTE:__ In this file, when we talk about times being in the _default timezone_,
we mean that they are "correct", the right UTC time. When they are "in a
local timezone" they are no longer correct, and should not be used for anything
but display. They have been shifted so as to be printed out correctly, but their
UTC values are are no longer correct.
*/

// [RequireJS](http://requirejs.org/) boilerplate, dependencies and
// [strict mode](http://mzl.la/1fRhnam)
if (typeof define !== 'function') {
  var define = require('amdefine')(module);
}

define([
  'lodash', 'moment', 'winston', 'util', 'fs', 'timezone-js', './string'
], function(
  _, moment, winston, util, fs, timezonejs, string
) {

  'use strict';

  // Setup
  // --------

  // In the browser we synchronously load timezone data from `window.tzUrl`.
  var tz = timezonejs.timezone;
  if (typeof window !== 'undefined') {
    var json = '{"zones":{"Pacific/Pago_Pago":[["-757.2","-","LMT","-2855692800000"],["682.8","-","LMT","-1830470400000"],["690","-","SAMT","-599702400000"],["660","-","NST","-86918400000"],["660","-","BST","438998400000"],["660","-","SST",null]],"US/Aleutian":"America/Adak","America/Adak":[["-733.35","-","LMT","-3225312000000"],["706.6333333333333","-","LMT","-2188987200000"],["660","-","NST","-852163200000"],["660","US","N%sT","-725932800000"],["660","-","NST","-86918400000"],["660","-","BST","-86400000"],["660","US","B%sT","436327200000"],["600","US","AH%sT","438998400000"],["600","US","HA%sT",null]],"US/Hawaii":"Pacific/Honolulu","Pacific/Honolulu":[["631.4333333333334","-","LMT","-2334139200000"],["630","-","HST","-1157320800000"],["630","1:00","HDT","-1155470400000"],["630","-","HST","-880236000000"],["630","1:00","HDT","-765410400000"],["630","-","HST","-712188000000"],["600","-","HST",null]],"US/Alaska":"America/Anchorage","America/Anchorage":[["-840.4","-","LMT","-3225312000000"],["599.6","-","LMT","-2188987200000"],["600","-","CAT","-852163200000"],["600","US","CAT/CAWT","-769395600000"],["600","US","CAT/CAPT","-725932800000"],["600","-","CAT","-86918400000"],["600","-","AHST","-86400000"],["600","US","AH%sT","436327200000"],["540","US","Y%sT","438998400000"],["540","US","AK%sT",null]],"Pacific/Gambier":[["539.8","-","LMT","-1806710400000"],["540","-","GAMT",null]],"US/Pacific":"America/Los_Angeles","America/Los_Angeles":[["472.9666666666667","-","LMT","-2717668378000"],["480","US","P%sT","-725932800000"],["480","CA","P%sT","-63244800000"],["480","US","P%sT",null]],"Pacific/Pitcairn":[["520.3333333333333","-","LMT","-2146003200000"],["510","-","PNT","893635200000"],["480","-","PST",null]],"US/Mountain":"America/Denver","America/Denver":[["419.93333333333334","-","LMT","-2717668796000"],["420","US","M%sT","-1546387200000"],["420","Denver","M%sT","-852163200000"],["420","US","M%sT","-725932800000"],["420","Denver","M%sT","-63244800000"],["420","US","M%sT",null]],"US/Arizona":"America/Phoenix","America/Phoenix":[["448.3","-","LMT","-2717670498000"],["420","US","M%sT","-820540740000"],["420","-","MST","-812678340000"],["420","US","M%sT","-796867140000"],["420","-","MST","-63244800000"],["420","US","M%sT","-56246400000"],["420","-","MST",null]],"US/Central":"America/Chicago","America/Chicago":[["350.6","-","LMT","-2717668236000"],["360","US","C%sT","-1546387200000"],["360","Chicago","C%sT","-1067810400000"],["300","-","EST","-1045432800000"],["360","Chicago","C%sT","-852163200000"],["360","US","C%sT","-725932800000"],["360","Chicago","C%sT","-63244800000"],["360","US","C%sT",null]],"America/Costa_Rica":[["336.2166666666667","-","LMT","-2493072000000"],["336.2166666666667","-","SJMT","-1545091200000"],["360","CR","C%sT",null]],"US/Eastern":"America/New_York","America/New_York":[["296.0333333333333","-","LMT","-2717668562000"],["300","US","E%sT","-1546387200000"],["300","NYC","E%sT","-852163200000"],["300","US","E%sT","-725932800000"],["300","NYC","E%sT","-63244800000"],["300","US","E%sT",null]],"EST":[["300","-","EST",null]],"Canada/Atlantic":"America/Halifax","America/Halifax":[["254.4","-","LMT","-2131660800000"],["240","Halifax","A%sT","-1609545600000"],["240","Canada","A%sT","-1578009600000"],["240","Halifax","A%sT","-880236000000"],["240","Canada","A%sT","-725932800000"],["240","Halifax","A%sT","157680000000"],["240","Canada","A%sT",null]],"Brazil/West":"America/Manaus","America/Manaus":[["240.06666666666666","-","LMT","-1735776000000"],["240","Brazil","AM%sT","590025600000"],["240","-","AMT","749174400000"],["240","Brazil","AM%sT","780192000000"],["240","-","AMT",null]],"Brazil/East":"America/Sao_Paulo","America/Sao_Paulo":[["186.46666666666667","-","LMT","-1735776000000"],["180","Brazil","BR%sT","-195436800000"],["180","1:00","BRST","-157852800000"],["180","Brazil","BR%sT",null]],"Atlantic/Stanley":[["231.4","-","LMT","-2493072000000"],["231.4","-","SMT","-1824249600000"],["240","Falk","FK%sT","420595200000"],["180","Falk","FK%sT","495590400000"],["240","Falk","FK%sT","1283652000000"],["180","-","FKST",null]],"America/Noronha":[["129.66666666666669","-","LMT","-1735776000000"],["120","Brazil","FN%sT","653529600000"],["120","-","FNT","938649600000"],["120","Brazil","FN%sT","971568000000"],["120","-","FNT","1000339200000"],["120","Brazil","FN%sT","1033430400000"],["120","-","FNT",null]],"Atlantic/Azores":[["102.66666666666667","-","LMT","-2682374400000"],["114.53333333333333","-","HMT","-1849564800000"],["120","Port","AZO%sT","-118274400000"],["60","Port","AZO%sT","433299600000"],["60","W-Eur","AZO%sT","717555600000"],["0","EU","WE%sT","733280400000"],["60","EU","AZO%sT",null]],"Atlantic/Cape_Verde":[["94.06666666666668","-","LMT","-1956700800000"],["120","-","CVT","-862617600000"],["120","1:00","CVST","-764121600000"],["120","-","CVT","186112800000"],["60","-","CVT",null]],"Europe/London":[["1.25","-","LMT","-3852662400000"],["0","GB-Eire","%s","-37238400000"],["-60","-","BST","57722400000"],["0","GB-Eire","%s","851990400000"],["0","EU","GMT/BST",null]],"UTC":"Etc/UTC","Etc/UTC":[["0","-","UTC",null]],"Europe/Rome":[["-49.93333333333334","-","LMT","-3259094400000"],["-49.93333333333334","-","RMT","-2403561600000"],["-60","Italy","CE%sT","-857253600000"],["-60","C-Eur","CE%sT","-804816000000"],["-60","Italy","CE%sT","347068800000"],["-60","EU","CE%sT",null]],"Africa/Algiers":[["-12.2","-","LMT","-2486678340000"],["-9.35","-","PMT","-1855958400000"],["0","Algeria","WE%sT","-942012000000"],["-60","Algeria","CE%sT","-733276800000"],["0","-","WET","-439430400000"],["-60","-","CET","-212025600000"],["0","Algeria","WE%sT","246240000000"],["-60","Algeria","CE%sT","309744000000"],["0","Algeria","WE%sT","357523200000"],["-60","-","CET",null]],"Europe/Istanbul":[["-115.86666666666667","-","LMT","-2808604800000"],["-116.93333333333332","-","IMT","-1869868800000"],["-120","Turkey","EE%sT","277257600000"],["-180","Turkey","TR%sT","482803200000"],["-120","Turkey","EE%sT","1199059200000"],["-120","EU","EE%sT","1301187600000"],["-120","-","EET","1301274000000"],["-120","EU","EE%sT","1396141200000"],["-120","-","EET","1396227600000"],["-120","EU","EE%sT",null]],"Africa/Cairo":[["-125.15","-","LMT","-2185401600000"],["-120","Egypt","EE%sT",null]],"Africa/Asmara":[["-155.53333333333333","-","LMT","-3124224000000"],["-155.53333333333333","-","AMT","-2493072000000"],["-155.33333333333334","-","ADMT","-1062201600000"],["-180","-","EAT",null]],"Asia/Baku":[["-199.4","-","LMT","-1441152000000"],["-180","-","BAKT","-405129600000"],["-240","RussiaAsia","BAK%sT","670384800000"],["-180","1:00","BAKST","683510400000"],["-180","RussiaAsia","AZ%sT","715388400000"],["-240","-","AZT","851990400000"],["-240","EUAsia","AZ%sT","883526400000"],["-240","Azer","AZ%sT",null]],"Asia/Dubai":[["-221.2","-","LMT","-1546387200000"],["-240","-","GST",null]],"Indian/Maldives":[["-294","-","LMT","-2808604800000"],["-294","-","MMT","-284083200000"],["-300","-","MVT",null]],"Asia/Almaty":[["-307.8","-","LMT","-1441152000000"],["-300","-","ALMT","-1247529600000"],["-360","RussiaAsia","ALM%sT","694137600000"],["-360","-","ALMT","725760000000"],["-360","RussiaAsia","ALM%sT","1110844800000"],["-360","-","ALMT",null]],"Asia/Bangkok":[["-402.06666666666666","-","LMT","-2808604800000"],["-402.06666666666666","-","BMT","-1570060800000"],["-420","-","ICT",null]],"Australia/West":"Australia/Perth","Australia/Perth":[["-463.4","-","LMT","-2337897600000"],["-480","Aus","WST","-836438400000"],["-480","AW","WST",null]],"Asia/Tokyo":[["-558.9833333333333","-","LMT","-2587712400000"],["-540","-","JST","-2303683200000"],["-540","-","CJT","-978393600000"],["-540","Japan","J%sT",null]],"Australia/Sydney":[["-604.8666666666667","-","LMT","-2364076800000"],["-600","Aus","EST","62985600000"],["-600","AN","EST",null]],"Pacific/Guam":[["861","-","LMT","-3944678400000"],["-579","-","LMT","-2146003200000"],["-600","-","GST","977529600000"],["-600","-","ChST",null]],"Asia/Vladivostok":[["-527.7333333333333","-","LMT","-1487289600000"],["-540","-","VLAT","-1247529600000"],["-600","Russia","VLA%sT","670384800000"],["-540","Russia","VLA%sST","695786400000"],["-600","Russia","VLA%sT","1301191200000"],["-660","-","VLAT",null]],"Pacific/Auckland":[["-699.0666666666666","-","LMT","-3192393600000"],["-690","NZ","NZ%sT","-757382400000"],["-720","NZ","NZ%sT",null]],"Asia/Kamchatka":[["-634.6","-","LMT","-1487721600000"],["-660","-","PETT","-1247529600000"],["-720","Russia","PET%sT","670384800000"],["-660","Russia","PET%sT","695786400000"],["-720","Russia","PET%sT","1269741600000"],["-660","Russia","PET%sT","1301191200000"],["-720","-","PETT",null]],"Pacific/Enderbury":[["684.3333333333334","-","LMT","-2146003200000"],["720","-","PHOT","307584000000"],["660","-","PHOT","820368000000"],["-780","-","PHOT",null]],"Pacific/Kiritimati":[["629.3333333333334","-","LMT","-2146003200000"],["640","-","LINT","307584000000"],["600","-","LINT","820368000000"],["-840","-","LINT",null]]},"rules":{"US":[["1918","1919","-","Mar","lastSun",["2","0","0",null],"60","D"],["1918","1919","-","Oct","lastSun",["2","0","0",null],"0","S"],["1942","only","-","Feb","9",["2","0","0",null],"60","W",""],["1945","only","-","Aug","14",["23","0","0","u"],"60","P",""],["1945","only","-","Sep","30",["2","0","0",null],"0","S"],["1967","2006","-","Oct","lastSun",["2","0","0",null],"0","S"],["1967","1973","-","Apr","lastSun",["2","0","0",null],"60","D"],["1974","only","-","Jan","6",["2","0","0",null],"60","D"],["1975","only","-","Feb","23",["2","0","0",null],"60","D"],["1976","1986","-","Apr","lastSun",["2","0","0",null],"60","D"],["1987","2006","-","Apr","Sun>=1",["2","0","0",null],"60","D"],["2007","max","-","Mar","Sun>=8",["2","0","0",null],"60","D"],["2007","max","-","Nov","Sun>=1",["2","0","0",null],"0","S"]],"CA":[["1948","only","-","Mar","14",["2","0","0",null],"60","D"],["1949","only","-","Jan","1",["2","0","0",null],"0","S"],["1950","1966","-","Apr","lastSun",["2","0","0",null],"60","D"],["1950","1961","-","Sep","lastSun",["2","0","0",null],"0","S"],["1962","1966","-","Oct","lastSun",["2","0","0",null],"0","S"]],"Denver":[["1920","1921","-","Mar","lastSun",["2","0","0",null],"60","D"],["1920","only","-","Oct","lastSun",["2","0","0",null],"0","S"],["1921","only","-","May","22",["2","0","0",null],"0","S"],["1965","1966","-","Apr","lastSun",["2","0","0",null],"60","D"],["1965","1966","-","Oct","lastSun",["2","0","0",null],"0","S"]],"Chicago":[["1920","only","-","Jun","13",["2","0","0",null],"60","D"],["1920","1921","-","Oct","lastSun",["2","0","0",null],"0","S"],["1921","only","-","Mar","lastSun",["2","0","0",null],"60","D"],["1922","1966","-","Apr","lastSun",["2","0","0",null],"60","D"],["1922","1954","-","Sep","lastSun",["2","0","0",null],"0","S"],["1955","1966","-","Oct","lastSun",["2","0","0",null],"0","S"]],"CR":[["1979","1980","-","Feb","lastSun",["0","0","0",null],"60","D"],["1979","1980","-","Jun","Sun>=1",["0","0","0",null],"0","S"],["1991","1992","-","Jan","Sat>=15",["0","0","0",null],"60","D"],["1991","only","-","Jul","1",["0","0","0",null],"0","S"],["1992","only","-","Mar","15",["0","0","0",null],"0","S"]],"NYC":[["1920","only","-","Mar","lastSun",["2","0","0",null],"60","D"],["1920","only","-","Oct","lastSun",["2","0","0",null],"0","S"],["1921","1966","-","Apr","lastSun",["2","0","0",null],"60","D"],["1921","1954","-","Sep","lastSun",["2","0","0",null],"0","S"],["1955","1966","-","Oct","lastSun",["2","0","0",null],"0","S"]],"Halifax":[["1916","only","-","Apr","1",["0","0","0",null],"60","D"],["1916","only","-","Oct","1",["0","0","0",null],"0","S"],["1920","only","-","May","9",["0","0","0",null],"60","D"],["1920","only","-","Aug","29",["0","0","0",null],"0","S"],["1921","only","-","May","6",["0","0","0",null],"60","D"],["1921","1922","-","Sep","5",["0","0","0",null],"0","S"],["1922","only","-","Apr","30",["0","0","0",null],"60","D"],["1923","1925","-","May","Sun>=1",["0","0","0",null],"60","D"],["1923","only","-","Sep","4",["0","0","0",null],"0","S"],["1924","only","-","Sep","15",["0","0","0",null],"0","S"],["1925","only","-","Sep","28",["0","0","0",null],"0","S"],["1926","only","-","May","16",["0","0","0",null],"60","D"],["1926","only","-","Sep","13",["0","0","0",null],"0","S"],["1927","only","-","May","1",["0","0","0",null],"60","D"],["1927","only","-","Sep","26",["0","0","0",null],"0","S"],["1928","1931","-","May","Sun>=8",["0","0","0",null],"60","D"],["1928","only","-","Sep","9",["0","0","0",null],"0","S"],["1929","only","-","Sep","3",["0","0","0",null],"0","S"],["1930","only","-","Sep","15",["0","0","0",null],"0","S"],["1931","1932","-","Sep","Mon>=24",["0","0","0",null],"0","S"],["1932","only","-","May","1",["0","0","0",null],"60","D"],["1933","only","-","Apr","30",["0","0","0",null],"60","D"],["1933","only","-","Oct","2",["0","0","0",null],"0","S"],["1934","only","-","May","20",["0","0","0",null],"60","D"],["1934","only","-","Sep","16",["0","0","0",null],"0","S"],["1935","only","-","Jun","2",["0","0","0",null],"60","D"],["1935","only","-","Sep","30",["0","0","0",null],"0","S"],["1936","only","-","Jun","1",["0","0","0",null],"60","D"],["1936","only","-","Sep","14",["0","0","0",null],"0","S"],["1937","1938","-","May","Sun>=1",["0","0","0",null],"60","D"],["1937","1941","-","Sep","Mon>=24",["0","0","0",null],"0","S"],["1939","only","-","May","28",["0","0","0",null],"60","D"],["1940","1941","-","May","Sun>=1",["0","0","0",null],"60","D"],["1946","1949","-","Apr","lastSun",["2","0","0",null],"60","D"],["1946","1949","-","Sep","lastSun",["2","0","0",null],"0","S"],["1951","1954","-","Apr","lastSun",["2","0","0",null],"60","D"],["1951","1954","-","Sep","lastSun",["2","0","0",null],"0","S"],["1956","1959","-","Apr","lastSun",["2","0","0",null],"60","D"],["1956","1959","-","Sep","lastSun",["2","0","0",null],"0","S"],["1962","1973","-","Apr","lastSun",["2","0","0",null],"60","D"],["1962","1973","-","Oct","lastSun",["2","0","0",null],"0","S"]],"Canada":[["1918","only","-","Apr","14",["2","0","0",null],"60","D"],["1918","only","-","Oct","27",["2","0","0",null],"0","S"],["1942","only","-","Feb","9",["2","0","0",null],"60","W",""],["1945","only","-","Aug","14",["23","0","0","u"],"60","P",""],["1945","only","-","Sep","30",["2","0","0",null],"0","S"],["1974","1986","-","Apr","lastSun",["2","0","0",null],"60","D"],["1974","2006","-","Oct","lastSun",["2","0","0",null],"0","S"],["1987","2006","-","Apr","Sun>=1",["2","0","0",null],"60","D"],["2007","max","-","Mar","Sun>=8",["2","0","0",null],"60","D"],["2007","max","-","Nov","Sun>=1",["2","0","0",null],"0","S"]],"Brazil":[["1931","only","-","Oct","3",["11","0","0",null],"60","S"],["1932","1933","-","Apr","1",["0","0","0",null],"0","-"],["1932","only","-","Oct","3",["0","0","0",null],"60","S"],["1949","1952","-","Dec","1",["0","0","0",null],"60","S"],["1950","only","-","Apr","16",["1","0","0",null],"0","-"],["1951","1952","-","Apr","1",["0","0","0",null],"0","-"],["1953","only","-","Mar","1",["0","0","0",null],"0","-"],["1963","only","-","Dec","9",["0","0","0",null],"60","S"],["1964","only","-","Mar","1",["0","0","0",null],"0","-"],["1965","only","-","Jan","31",["0","0","0",null],"60","S"],["1965","only","-","Mar","31",["0","0","0",null],"0","-"],["1965","only","-","Dec","1",["0","0","0",null],"60","S"],["1966","1968","-","Mar","1",["0","0","0",null],"0","-"],["1966","1967","-","Nov","1",["0","0","0",null],"60","S"],["1985","only","-","Nov","2",["0","0","0",null],"60","S"],["1986","only","-","Mar","15",["0","0","0",null],"0","-"],["1986","only","-","Oct","25",["0","0","0",null],"60","S"],["1987","only","-","Feb","14",["0","0","0",null],"0","-"],["1987","only","-","Oct","25",["0","0","0",null],"60","S"],["1988","only","-","Feb","7",["0","0","0",null],"0","-"],["1988","only","-","Oct","16",["0","0","0",null],"60","S"],["1989","only","-","Jan","29",["0","0","0",null],"0","-"],["1989","only","-","Oct","15",["0","0","0",null],"60","S"],["1990","only","-","Feb","11",["0","0","0",null],"0","-"],["1990","only","-","Oct","21",["0","0","0",null],"60","S"],["1991","only","-","Feb","17",["0","0","0",null],"0","-"],["1991","only","-","Oct","20",["0","0","0",null],"60","S"],["1992","only","-","Feb","9",["0","0","0",null],"0","-"],["1992","only","-","Oct","25",["0","0","0",null],"60","S"],["1993","only","-","Jan","31",["0","0","0",null],"0","-"],["1993","1995","-","Oct","Sun>=11",["0","0","0",null],"60","S"],["1994","1995","-","Feb","Sun>=15",["0","0","0",null],"0","-"],["1996","only","-","Feb","11",["0","0","0",null],"0","-"],["1996","only","-","Oct","6",["0","0","0",null],"60","S"],["1997","only","-","Feb","16",["0","0","0",null],"0","-"],["1997","only","-","Oct","6",["0","0","0",null],"60","S"],["1998","only","-","Mar","1",["0","0","0",null],"0","-"],["1998","only","-","Oct","11",["0","0","0",null],"60","S"],["1999","only","-","Feb","21",["0","0","0",null],"0","-"],["1999","only","-","Oct","3",["0","0","0",null],"60","S"],["2000","only","-","Feb","27",["0","0","0",null],"0","-"],["2000","2001","-","Oct","Sun>=8",["0","0","0",null],"60","S"],["2001","2006","-","Feb","Sun>=15",["0","0","0",null],"0","-"],["2002","only","-","Nov","3",["0","0","0",null],"60","S"],["2003","only","-","Oct","19",["0","0","0",null],"60","S"],["2004","only","-","Nov","2",["0","0","0",null],"60","S"],["2005","only","-","Oct","16",["0","0","0",null],"60","S"],["2006","only","-","Nov","5",["0","0","0",null],"60","S"],["2007","only","-","Feb","25",["0","0","0",null],"0","-"],["2007","only","-","Oct","Sun>=8",["0","0","0",null],"60","S"],["2008","max","-","Oct","Sun>=15",["0","0","0",null],"60","S"],["2008","2011","-","Feb","Sun>=15",["0","0","0",null],"0","-"],["2012","only","-","Feb","Sun>=22",["0","0","0",null],"0","-"],["2013","2014","-","Feb","Sun>=15",["0","0","0",null],"0","-"],["2015","only","-","Feb","Sun>=22",["0","0","0",null],"0","-"],["2016","2022","-","Feb","Sun>=15",["0","0","0",null],"0","-"],["2023","only","-","Feb","Sun>=22",["0","0","0",null],"0","-"],["2024","2025","-","Feb","Sun>=15",["0","0","0",null],"0","-"],["2026","only","-","Feb","Sun>=22",["0","0","0",null],"0","-"],["2027","2033","-","Feb","Sun>=15",["0","0","0",null],"0","-"],["2034","only","-","Feb","Sun>=22",["0","0","0",null],"0","-"],["2035","2036","-","Feb","Sun>=15",["0","0","0",null],"0","-"],["2037","only","-","Feb","Sun>=22",["0","0","0",null],"0","-"],["2038","max","-","Feb","Sun>=15",["0","0","0",null],"0","-"]],"Falk":[["1937","1938","-","Sep","lastSun",["0","0","0",null],"60","S"],["1938","1942","-","Mar","Sun>=19",["0","0","0",null],"0","-"],["1939","only","-","Oct","1",["0","0","0",null],"60","S"],["1940","1942","-","Sep","lastSun",["0","0","0",null],"60","S"],["1943","only","-","Jan","1",["0","0","0",null],"0","-"],["1983","only","-","Sep","lastSun",["0","0","0",null],"60","S"],["1984","1985","-","Apr","lastSun",["0","0","0",null],"0","-"],["1984","only","-","Sep","16",["0","0","0",null],"60","S"],["1985","2000","-","Sep","Sun>=9",["0","0","0",null],"60","S"],["1986","2000","-","Apr","Sun>=16",["0","0","0",null],"0","-"],["2001","2010","-","Apr","Sun>=15",["2","0","0",null],"0","-"],["2001","2010","-","Sep","Sun>=1",["2","0","0",null],"60","S"]],"Port":[["1916","only","-","Jun","17",["23","0","0",null],"60","S"],["1916","only","-","Nov","1",["1","0","0",null],"0","-"],["1917","only","-","Feb","28",["23","0","0","s"],"60","S"],["1917","1921","-","Oct","14",["23","0","0","s"],"0","-"],["1918","only","-","Mar","1",["23","0","0","s"],"60","S"],["1919","only","-","Feb","28",["23","0","0","s"],"60","S"],["1920","only","-","Feb","29",["23","0","0","s"],"60","S"],["1921","only","-","Feb","28",["23","0","0","s"],"60","S"],["1924","only","-","Apr","16",["23","0","0","s"],"60","S"],["1924","only","-","Oct","14",["23","0","0","s"],"0","-"],["1926","only","-","Apr","17",["23","0","0","s"],"60","S"],["1926","1929","-","Oct","Sat>=1",["23","0","0","s"],"0","-"],["1927","only","-","Apr","9",["23","0","0","s"],"60","S"],["1928","only","-","Apr","14",["23","0","0","s"],"60","S"],["1929","only","-","Apr","20",["23","0","0","s"],"60","S"],["1931","only","-","Apr","18",["23","0","0","s"],"60","S"],["1931","1932","-","Oct","Sat>=1",["23","0","0","s"],"0","-"],["1932","only","-","Apr","2",["23","0","0","s"],"60","S"],["1934","only","-","Apr","7",["23","0","0","s"],"60","S"],["1934","1938","-","Oct","Sat>=1",["23","0","0","s"],"0","-"],["1935","only","-","Mar","30",["23","0","0","s"],"60","S"],["1936","only","-","Apr","18",["23","0","0","s"],"60","S"],["1937","only","-","Apr","3",["23","0","0","s"],"60","S"],["1938","only","-","Mar","26",["23","0","0","s"],"60","S"],["1939","only","-","Apr","15",["23","0","0","s"],"60","S"],["1939","only","-","Nov","18",["23","0","0","s"],"0","-"],["1940","only","-","Feb","24",["23","0","0","s"],"60","S"],["1940","1941","-","Oct","5",["23","0","0","s"],"0","-"],["1941","only","-","Apr","5",["23","0","0","s"],"60","S"],["1942","1945","-","Mar","Sat>=8",["23","0","0","s"],"60","S"],["1942","only","-","Apr","25",["22","0","0","s"],"120","M",""],["1942","only","-","Aug","15",["22","0","0","s"],"60","S"],["1942","1945","-","Oct","Sat>=24",["23","0","0","s"],"0","-"],["1943","only","-","Apr","17",["22","0","0","s"],"120","M"],["1943","1945","-","Aug","Sat>=25",["22","0","0","s"],"60","S"],["1944","1945","-","Apr","Sat>=21",["22","0","0","s"],"120","M"],["1946","only","-","Apr","Sat>=1",["23","0","0","s"],"60","S"],["1946","only","-","Oct","Sat>=1",["23","0","0","s"],"0","-"],["1947","1949","-","Apr","Sun>=1",["2","0","0","s"],"60","S"],["1947","1949","-","Oct","Sun>=1",["2","0","0","s"],"0","-"],["1951","1965","-","Apr","Sun>=1",["2","0","0","s"],"60","S"],["1951","1965","-","Oct","Sun>=1",["2","0","0","s"],"0","-"],["1977","only","-","Mar","27",["0","0","0","s"],"60","S"],["1977","only","-","Sep","25",["0","0","0","s"],"0","-"],["1978","1979","-","Apr","Sun>=1",["0","0","0","s"],"60","S"],["1978","only","-","Oct","1",["0","0","0","s"],"0","-"],["1979","1982","-","Sep","lastSun",["1","0","0","s"],"0","-"],["1980","only","-","Mar","lastSun",["0","0","0","s"],"60","S"],["1981","1982","-","Mar","lastSun",["1","0","0","s"],"60","S"],["1983","only","-","Mar","lastSun",["2","0","0","s"],"60","S"]],"W-Eur":[["1977","1980","-","Apr","Sun>=1",["1","0","0","s"],"60","S"],["1977","only","-","Sep","lastSun",["1","0","0","s"],"0","-"],["1978","only","-","Oct","1",["1","0","0","s"],"0","-"],["1979","1995","-","Sep","lastSun",["1","0","0","s"],"0","-"],["1981","max","-","Mar","lastSun",["1","0","0","s"],"60","S"],["1996","max","-","Oct","lastSun",["1","0","0","s"],"0","-"]],"EU":[["1977","1980","-","Apr","Sun>=1",["1","0","0","u"],"60","S"],["1977","only","-","Sep","lastSun",["1","0","0","u"],"0","-"],["1978","only","-","Oct","1",["1","0","0","u"],"0","-"],["1979","1995","-","Sep","lastSun",["1","0","0","u"],"0","-"],["1981","max","-","Mar","lastSun",["1","0","0","u"],"60","S"],["1996","max","-","Oct","lastSun",["1","0","0","u"],"0","-"]],"GB-Eire":[["1916","only","-","May","21",["2","0","0","s"],"60","BST"],["1916","only","-","Oct","1",["2","0","0","s"],"0","GMT"],["1917","only","-","Apr","8",["2","0","0","s"],"60","BST"],["1917","only","-","Sep","17",["2","0","0","s"],"0","GMT"],["1918","only","-","Mar","24",["2","0","0","s"],"60","BST"],["1918","only","-","Sep","30",["2","0","0","s"],"0","GMT"],["1919","only","-","Mar","30",["2","0","0","s"],"60","BST"],["1919","only","-","Sep","29",["2","0","0","s"],"0","GMT"],["1920","only","-","Mar","28",["2","0","0","s"],"60","BST"],["1920","only","-","Oct","25",["2","0","0","s"],"0","GMT"],["1921","only","-","Apr","3",["2","0","0","s"],"60","BST"],["1921","only","-","Oct","3",["2","0","0","s"],"0","GMT"],["1922","only","-","Mar","26",["2","0","0","s"],"60","BST"],["1922","only","-","Oct","8",["2","0","0","s"],"0","GMT"],["1923","only","-","Apr","Sun>=16",["2","0","0","s"],"60","BST"],["1923","1924","-","Sep","Sun>=16",["2","0","0","s"],"0","GMT"],["1924","only","-","Apr","Sun>=9",["2","0","0","s"],"60","BST"],["1925","1926","-","Apr","Sun>=16",["2","0","0","s"],"60","BST"],["1925","1938","-","Oct","Sun>=2",["2","0","0","s"],"0","GMT"],["1927","only","-","Apr","Sun>=9",["2","0","0","s"],"60","BST"],["1928","1929","-","Apr","Sun>=16",["2","0","0","s"],"60","BST"],["1930","only","-","Apr","Sun>=9",["2","0","0","s"],"60","BST"],["1931","1932","-","Apr","Sun>=16",["2","0","0","s"],"60","BST"],["1933","only","-","Apr","Sun>=9",["2","0","0","s"],"60","BST"],["1934","only","-","Apr","Sun>=16",["2","0","0","s"],"60","BST"],["1935","only","-","Apr","Sun>=9",["2","0","0","s"],"60","BST"],["1936","1937","-","Apr","Sun>=16",["2","0","0","s"],"60","BST"],["1938","only","-","Apr","Sun>=9",["2","0","0","s"],"60","BST"],["1939","only","-","Apr","Sun>=16",["2","0","0","s"],"60","BST"],["1939","only","-","Nov","Sun>=16",["2","0","0","s"],"0","GMT"],["1940","only","-","Feb","Sun>=23",["2","0","0","s"],"60","BST"],["1941","only","-","May","Sun>=2",["1","0","0","s"],"120","BDST"],["1941","1943","-","Aug","Sun>=9",["1","0","0","s"],"60","BST"],["1942","1944","-","Apr","Sun>=2",["1","0","0","s"],"120","BDST"],["1944","only","-","Sep","Sun>=16",["1","0","0","s"],"60","BST"],["1945","only","-","Apr","Mon>=2",["1","0","0","s"],"120","BDST"],["1945","only","-","Jul","Sun>=9",["1","0","0","s"],"60","BST"],["1945","1946","-","Oct","Sun>=2",["2","0","0","s"],"0","GMT"],["1946","only","-","Apr","Sun>=9",["2","0","0","s"],"60","BST"],["1947","only","-","Mar","16",["2","0","0","s"],"60","BST"],["1947","only","-","Apr","13",["1","0","0","s"],"120","BDST"],["1947","only","-","Aug","10",["1","0","0","s"],"60","BST"],["1947","only","-","Nov","2",["2","0","0","s"],"0","GMT"],["1948","only","-","Mar","14",["2","0","0","s"],"60","BST"],["1948","only","-","Oct","31",["2","0","0","s"],"0","GMT"],["1949","only","-","Apr","3",["2","0","0","s"],"60","BST"],["1949","only","-","Oct","30",["2","0","0","s"],"0","GMT"],["1950","1952","-","Apr","Sun>=14",["2","0","0","s"],"60","BST"],["1950","1952","-","Oct","Sun>=21",["2","0","0","s"],"0","GMT"],["1953","only","-","Apr","Sun>=16",["2","0","0","s"],"60","BST"],["1953","1960","-","Oct","Sun>=2",["2","0","0","s"],"0","GMT"],["1954","only","-","Apr","Sun>=9",["2","0","0","s"],"60","BST"],["1955","1956","-","Apr","Sun>=16",["2","0","0","s"],"60","BST"],["1957","only","-","Apr","Sun>=9",["2","0","0","s"],"60","BST"],["1958","1959","-","Apr","Sun>=16",["2","0","0","s"],"60","BST"],["1960","only","-","Apr","Sun>=9",["2","0","0","s"],"60","BST"],["1961","1963","-","Mar","lastSun",["2","0","0","s"],"60","BST"],["1961","1968","-","Oct","Sun>=23",["2","0","0","s"],"0","GMT"],["1964","1967","-","Mar","Sun>=19",["2","0","0","s"],"60","BST"],["1968","only","-","Feb","18",["2","0","0","s"],"60","BST"],["1972","1980","-","Mar","Sun>=16",["2","0","0","s"],"60","BST"],["1972","1980","-","Oct","Sun>=23",["2","0","0","s"],"0","GMT"],["1981","1995","-","Mar","lastSun",["1","0","0","u"],"60","BST"],["1981","1989","-","Oct","Sun>=23",["1","0","0","u"],"0","GMT"],["1990","1995","-","Oct","Sun>=22",["1","0","0","u"],"0","GMT"]],"Italy":[["1916","only","-","Jun","3",["0","0","0","s"],"60","S"],["1916","only","-","Oct","1",["0","0","0","s"],"0","-"],["1917","only","-","Apr","1",["0","0","0","s"],"60","S"],["1917","only","-","Sep","30",["0","0","0","s"],"0","-"],["1918","only","-","Mar","10",["0","0","0","s"],"60","S"],["1918","1919","-","Oct","Sun>=1",["0","0","0","s"],"0","-"],["1919","only","-","Mar","2",["0","0","0","s"],"60","S"],["1920","only","-","Mar","21",["0","0","0","s"],"60","S"],["1920","only","-","Sep","19",["0","0","0","s"],"0","-"],["1940","only","-","Jun","15",["0","0","0","s"],"60","S"],["1944","only","-","Sep","17",["0","0","0","s"],"0","-"],["1945","only","-","Apr","2",["2","0","0",null],"60","S"],["1945","only","-","Sep","15",["0","0","0","s"],"0","-"],["1946","only","-","Mar","17",["2","0","0","s"],"60","S"],["1946","only","-","Oct","6",["2","0","0","s"],"0","-"],["1947","only","-","Mar","16",["0","0","0","s"],"60","S"],["1947","only","-","Oct","5",["0","0","0","s"],"0","-"],["1948","only","-","Feb","29",["2","0","0","s"],"60","S"],["1948","only","-","Oct","3",["2","0","0","s"],"0","-"],["1966","1968","-","May","Sun>=22",["0","0","0",null],"60","S"],["1966","1969","-","Sep","Sun>=22",["0","0","0",null],"0","-"],["1969","only","-","Jun","1",["0","0","0",null],"60","S"],["1970","only","-","May","31",["0","0","0",null],"60","S"],["1970","only","-","Sep","lastSun",["0","0","0",null],"0","-"],["1971","1972","-","May","Sun>=22",["0","0","0",null],"60","S"],["1971","only","-","Sep","lastSun",["1","0","0",null],"0","-"],["1972","only","-","Oct","1",["0","0","0",null],"0","-"],["1973","only","-","Jun","3",["0","0","0",null],"60","S"],["1973","1974","-","Sep","lastSun",["0","0","0",null],"0","-"],["1974","only","-","May","26",["0","0","0",null],"60","S"],["1975","only","-","Jun","1",["0","0","0","s"],"60","S"],["1975","1977","-","Sep","lastSun",["0","0","0","s"],"0","-"],["1976","only","-","May","30",["0","0","0","s"],"60","S"],["1977","1979","-","May","Sun>=22",["0","0","0","s"],"60","S"],["1978","only","-","Oct","1",["0","0","0","s"],"0","-"],["1979","only","-","Sep","30",["0","0","0","s"],"0","-"]],"C-Eur":[["1916","only","-","Apr","30",["23","0","0",null],"60","S"],["1916","only","-","Oct","1",["1","0","0",null],"0","-"],["1917","1918","-","Apr","Mon>=15",["2","0","0","s"],"60","S"],["1917","1918","-","Sep","Mon>=15",["2","0","0","s"],"0","-"],["1940","only","-","Apr","1",["2","0","0","s"],"60","S"],["1942","only","-","Nov","2",["2","0","0","s"],"0","-"],["1943","only","-","Mar","29",["2","0","0","s"],"60","S"],["1943","only","-","Oct","4",["2","0","0","s"],"0","-"],["1944","1945","-","Apr","Mon>=1",["2","0","0","s"],"60","S"],["1944","only","-","Oct","2",["2","0","0","s"],"0","-"],["1945","only","-","Sep","16",["2","0","0","s"],"0","-"],["1977","1980","-","Apr","Sun>=1",["2","0","0","s"],"60","S"],["1977","only","-","Sep","lastSun",["2","0","0","s"],"0","-"],["1978","only","-","Oct","1",["2","0","0","s"],"0","-"],["1979","1995","-","Sep","lastSun",["2","0","0","s"],"0","-"],["1981","max","-","Mar","lastSun",["2","0","0","s"],"60","S"],["1996","max","-","Oct","lastSun",["2","0","0","s"],"0","-"]],"Algeria":[["1916","only","-","Jun","14",["23","0","0","s"],"60","S"],["1916","1919","-","Oct","Sun>=1",["23","0","0","s"],"0","-"],["1917","only","-","Mar","24",["23","0","0","s"],"60","S"],["1918","only","-","Mar","9",["23","0","0","s"],"60","S"],["1919","only","-","Mar","1",["23","0","0","s"],"60","S"],["1920","only","-","Feb","14",["23","0","0","s"],"60","S"],["1920","only","-","Oct","23",["23","0","0","s"],"0","-"],["1921","only","-","Mar","14",["23","0","0","s"],"60","S"],["1921","only","-","Jun","21",["23","0","0","s"],"0","-"],["1939","only","-","Sep","11",["23","0","0","s"],"60","S"],["1939","only","-","Nov","19",["1","0","0",null],"0","-"],["1944","1945","-","Apr","Mon>=1",["2","0","0",null],"60","S"],["1944","only","-","Oct","8",["2","0","0",null],"0","-"],["1945","only","-","Sep","16",["1","0","0",null],"0","-"],["1971","only","-","Apr","25",["23","0","0","s"],"60","S"],["1971","only","-","Sep","26",["23","0","0","s"],"0","-"],["1977","only","-","May","6",["0","0","0",null],"60","S"],["1977","only","-","Oct","21",["0","0","0",null],"0","-"],["1978","only","-","Mar","24",["1","0","0",null],"60","S"],["1978","only","-","Sep","22",["3","0","0",null],"0","-"],["1980","only","-","Apr","25",["0","0","0",null],"60","S"],["1980","only","-","Oct","31",["2","0","0",null],"0","-"]],"Turkey":[["1916","only","-","May","1",["0","0","0",null],"60","S"],["1916","only","-","Oct","1",["0","0","0",null],"0","-"],["1920","only","-","Mar","28",["0","0","0",null],"60","S"],["1920","only","-","Oct","25",["0","0","0",null],"0","-"],["1921","only","-","Apr","3",["0","0","0",null],"60","S"],["1921","only","-","Oct","3",["0","0","0",null],"0","-"],["1922","only","-","Mar","26",["0","0","0",null],"60","S"],["1922","only","-","Oct","8",["0","0","0",null],"0","-"],["1924","only","-","May","13",["0","0","0",null],"60","S"],["1924","1925","-","Oct","1",["0","0","0",null],"0","-"],["1925","only","-","May","1",["0","0","0",null],"60","S"],["1940","only","-","Jun","30",["0","0","0",null],"60","S"],["1940","only","-","Oct","5",["0","0","0",null],"0","-"],["1940","only","-","Dec","1",["0","0","0",null],"60","S"],["1941","only","-","Sep","21",["0","0","0",null],"0","-"],["1942","only","-","Apr","1",["0","0","0",null],"60","S"],["1942","only","-","Nov","1",["0","0","0",null],"0","-"],["1945","only","-","Apr","2",["0","0","0",null],"60","S"],["1945","only","-","Oct","8",["0","0","0",null],"0","-"],["1946","only","-","Jun","1",["0","0","0",null],"60","S"],["1946","only","-","Oct","1",["0","0","0",null],"0","-"],["1947","1948","-","Apr","Sun>=16",["0","0","0",null],"60","S"],["1947","1950","-","Oct","Sun>=2",["0","0","0",null],"0","-"],["1949","only","-","Apr","10",["0","0","0",null],"60","S"],["1950","only","-","Apr","19",["0","0","0",null],"60","S"],["1951","only","-","Apr","22",["0","0","0",null],"60","S"],["1951","only","-","Oct","8",["0","0","0",null],"0","-"],["1962","only","-","Jul","15",["0","0","0",null],"60","S"],["1962","only","-","Oct","8",["0","0","0",null],"0","-"],["1964","only","-","May","15",["0","0","0",null],"60","S"],["1964","only","-","Oct","1",["0","0","0",null],"0","-"],["1970","1972","-","May","Sun>=2",["0","0","0",null],"60","S"],["1970","1972","-","Oct","Sun>=2",["0","0","0",null],"0","-"],["1973","only","-","Jun","3",["1","0","0",null],"60","S"],["1973","only","-","Nov","4",["3","0","0",null],"0","-"],["1974","only","-","Mar","31",["2","0","0",null],"60","S"],["1974","only","-","Nov","3",["5","0","0",null],"0","-"],["1975","only","-","Mar","30",["0","0","0",null],"60","S"],["1975","1976","-","Oct","lastSun",["0","0","0",null],"0","-"],["1976","only","-","Jun","1",["0","0","0",null],"60","S"],["1977","1978","-","Apr","Sun>=1",["0","0","0",null],"60","S"],["1977","only","-","Oct","16",["0","0","0",null],"0","-"],["1979","1980","-","Apr","Sun>=1",["3","0","0",null],"60","S"],["1979","1982","-","Oct","Mon>=11",["0","0","0",null],"0","-"],["1981","1982","-","Mar","lastSun",["3","0","0",null],"60","S"],["1983","only","-","Jul","31",["0","0","0",null],"60","S"],["1983","only","-","Oct","2",["0","0","0",null],"0","-"],["1985","only","-","Apr","20",["0","0","0",null],"60","S"],["1985","only","-","Sep","28",["0","0","0",null],"0","-"],["1986","1990","-","Mar","lastSun",["2","0","0","s"],"60","S"],["1986","1990","-","Sep","lastSun",["2","0","0","s"],"0","-"],["1991","2006","-","Mar","lastSun",["1","0","0","s"],"60","S"],["1991","1995","-","Sep","lastSun",["1","0","0","s"],"0","-"],["1996","2006","-","Oct","lastSun",["1","0","0","s"],"0","-"]],"Egypt":[["1940","only","-","Jul","15",["0","0","0",null],"60","S"],["1940","only","-","Oct","1",["0","0","0",null],"0","-"],["1941","only","-","Apr","15",["0","0","0",null],"60","S"],["1941","only","-","Sep","16",["0","0","0",null],"0","-"],["1942","1944","-","Apr","1",["0","0","0",null],"60","S"],["1942","only","-","Oct","27",["0","0","0",null],"0","-"],["1943","1945","-","Nov","1",["0","0","0",null],"0","-"],["1945","only","-","Apr","16",["0","0","0",null],"60","S"],["1957","only","-","May","10",["0","0","0",null],"60","S"],["1957","1958","-","Oct","1",["0","0","0",null],"0","-"],["1958","only","-","May","1",["0","0","0",null],"60","S"],["1959","1981","-","May","1",["1","0","0",null],"60","S"],["1959","1965","-","Sep","30",["3","0","0",null],"0","-"],["1966","1994","-","Oct","1",["3","0","0",null],"0","-"],["1982","only","-","Jul","25",["1","0","0",null],"60","S"],["1983","only","-","Jul","12",["1","0","0",null],"60","S"],["1984","1988","-","May","1",["1","0","0",null],"60","S"],["1989","only","-","May","6",["1","0","0",null],"60","S"],["1990","1994","-","May","1",["1","0","0",null],"60","S"],["1995","2010","-","Apr","lastFri",["0","0","0","s"],"60","S"],["1995","2005","-","Sep","lastThu",["23","0","0","s"],"0","-"],["2006","only","-","Sep","21",["23","0","0","s"],"0","-"],["2007","only","-","Sep","Thu>=1",["23","0","0","s"],"0","-"],["2008","only","-","Aug","lastThu",["23","0","0","s"],"0","-"],["2009","only","-","Aug","20",["23","0","0","s"],"0","-"],["2010","only","-","Aug","11",["0","0","0",null],"0","-"],["2010","only","-","Sep","10",["0","0","0",null],"60","S"],["2010","only","-","Sep","lastThu",["23","0","0","s"],"0","-"],["2014","only","-","May","15",["24","0","0",null],"60","S"],["2014","only","-","Jun","29",["0","0","0","s"],"0","-"],["2014","only","-","Jul","29",["0","0","0","s"],"60","S"],["2014","max","-","Sep","lastThu",["23","0","0","s"],"0","-"],["2015","2019","-","Apr","lastFri",["0","0","0","s"],"60","S"],["2015","only","-","Jun","18",["0","0","0","s"],"0","-"],["2015","only","-","Jul","18",["0","0","0","s"],"60","S"],["2016","only","-","Jun","7",["0","0","0","s"],"0","-"],["2016","only","-","Jul","7",["0","0","0","s"],"60","S"],["2017","only","-","May","27",["0","0","0","s"],"0","-"],["2017","only","-","Jun","26",["0","0","0","s"],"60","S"],["2018","only","-","May","16",["0","0","0","s"],"0","-"],["2018","only","-","Jun","15",["0","0","0","s"],"60","S"],["2019","only","-","May","6",["0","0","0","s"],"0","-"],["2019","only","-","Jun","5",["0","0","0","s"],"60","S"],["2020","only","-","May","24",["0","0","0","s"],"60","S"],["2021","only","-","May","13",["0","0","0","s"],"60","S"],["2022","only","-","May","3",["0","0","0","s"],"60","S"],["2023","max","-","Apr","lastFri",["0","0","0","s"],"60","S"]],"RussiaAsia":[["1981","1984","-","Apr","1",["0","0","0",null],"60","S"],["1981","1983","-","Oct","1",["0","0","0",null],"0","-"],["1984","1991","-","Sep","lastSun",["2","0","0","s"],"0","-"],["1985","1991","-","Mar","lastSun",["2","0","0","s"],"60","S"],["1992","only","-","Mar","lastSat",["23","0","0",null],"60","S"],["1992","only","-","Sep","lastSat",["23","0","0",null],"0","-"],["1993","max","-","Mar","lastSun",["2","0","0","s"],"60","S"],["1993","1995","-","Sep","lastSun",["2","0","0","s"],"0","-"],["1996","max","-","Oct","lastSun",["2","0","0","s"],"0","-"]],"EUAsia":[["1981","max","-","Mar","lastSun",["1","0","0","u"],"60","S"],["1979","1995","-","Sep","lastSun",["1","0","0","u"],"0","-"],["1996","max","-","Oct","lastSun",["1","0","0","u"],"0","-"]],"Azer":[["1997","max","-","Mar","lastSun",["4","0","0",null],"60","S"],["1997","max","-","Oct","lastSun",["5","0","0",null],"0","-"]],"Aus":[["1917","only","-","Jan","1",["0","1","0",null],"60","-"],["1917","only","-","Mar","25",["2","0","0",null],"0","-"],["1942","only","-","Jan","1",["2","0","0",null],"60","-"],["1942","only","-","Mar","29",["2","0","0",null],"0","-"],["1942","only","-","Sep","27",["2","0","0",null],"60","-"],["1943","1944","-","Mar","lastSun",["2","0","0",null],"0","-"],["1943","only","-","Oct","3",["2","0","0",null],"60","-"]],"AW":[["1974","only","-","Oct","lastSun",["2","0","0","s"],"60","-"],["1975","only","-","Mar","Sun>=1",["2","0","0","s"],"0","-"],["1983","only","-","Oct","lastSun",["2","0","0","s"],"60","-"],["1984","only","-","Mar","Sun>=1",["2","0","0","s"],"0","-"],["1991","only","-","Nov","17",["2","0","0","s"],"60","-"],["1992","only","-","Mar","Sun>=1",["2","0","0","s"],"0","-"],["2006","only","-","Dec","3",["2","0","0","s"],"60","-"],["2007","2009","-","Mar","lastSun",["2","0","0","s"],"0","-"],["2007","2008","-","Oct","lastSun",["2","0","0","s"],"60","-"]],"Japan":[["1948","only","-","May","Sun>=1",["2","0","0",null],"60","D"],["1948","1951","-","Sep","Sat>=8",["2","0","0",null],"0","S"],["1949","only","-","Apr","Sun>=1",["2","0","0",null],"60","D"],["1950","1951","-","May","Sun>=1",["2","0","0",null],"60","D"]],"AN":[["1971","1985","-","Oct","lastSun",["2","0","0","s"],"60","-"],["1972","only","-","Feb","27",["2","0","0","s"],"0","-"],["1973","1981","-","Mar","Sun>=1",["2","0","0","s"],"0","-"],["1982","only","-","Apr","Sun>=1",["2","0","0","s"],"0","-"],["1983","1985","-","Mar","Sun>=1",["2","0","0","s"],"0","-"],["1986","1989","-","Mar","Sun>=15",["2","0","0","s"],"0","-"],["1986","only","-","Oct","19",["2","0","0","s"],"60","-"],["1987","1999","-","Oct","lastSun",["2","0","0","s"],"60","-"],["1990","1995","-","Mar","Sun>=1",["2","0","0","s"],"0","-"],["1996","2005","-","Mar","lastSun",["2","0","0","s"],"0","-"],["2000","only","-","Aug","lastSun",["2","0","0","s"],"60","-"],["2001","2007","-","Oct","lastSun",["2","0","0","s"],"60","-"],["2006","only","-","Apr","Sun>=1",["2","0","0","s"],"0","-"],["2007","only","-","Mar","lastSun",["2","0","0","s"],"0","-"],["2008","max","-","Apr","Sun>=1",["2","0","0","s"],"0","-"],["2008","max","-","Oct","Sun>=1",["2","0","0","s"],"60","-"]],"Russia":[["1917","only","-","Jul","1",["23","0","0",null],"60","MST",""],["1917","only","-","Dec","28",["0","0","0",null],"0","MMT",""],["1918","only","-","May","31",["22","0","0",null],"120","MDST",""],["1918","only","-","Sep","16",["1","0","0",null],"60","MST"],["1919","only","-","May","31",["23","0","0",null],"120","MDST"],["1919","only","-","Jul","1",["2","0","0",null],"60","S"],["1919","only","-","Aug","16",["0","0","0",null],"0","-"],["1921","only","-","Feb","14",["23","0","0",null],"60","S"],["1921","only","-","Mar","20",["23","0","0",null],"120","M",""],["1921","only","-","Sep","1",["0","0","0",null],"60","S"],["1921","only","-","Oct","1",["0","0","0",null],"0","-"],["1981","1984","-","Apr","1",["0","0","0",null],"60","S"],["1981","1983","-","Oct","1",["0","0","0",null],"0","-"],["1984","1991","-","Sep","lastSun",["2","0","0","s"],"0","-"],["1985","1991","-","Mar","lastSun",["2","0","0","s"],"60","S"],["1992","only","-","Mar","lastSat",["23","0","0",null],"60","S"],["1992","only","-","Sep","lastSat",["23","0","0",null],"0","-"],["1993","2010","-","Mar","lastSun",["2","0","0","s"],"60","S"],["1993","1995","-","Sep","lastSun",["2","0","0","s"],"0","-"],["1996","2010","-","Oct","lastSun",["2","0","0","s"],"0","-"]],"NZ":[["1927","only","-","Nov","6",["2","0","0",null],"60","S"],["1928","only","-","Mar","4",["2","0","0",null],"0","M"],["1928","1933","-","Oct","Sun>=8",["2","0","0",null],"30","S"],["1929","1933","-","Mar","Sun>=15",["2","0","0",null],"0","M"],["1934","1940","-","Apr","lastSun",["2","0","0",null],"0","M"],["1934","1940","-","Sep","lastSun",["2","0","0",null],"30","S"],["1946","only","-","Jan","1",["0","0","0",null],"0","S"],["1974","only","-","Nov","Sun>=1",["2","0","0","s"],"60","D"],["1975","only","-","Feb","lastSun",["2","0","0","s"],"0","S"],["1975","1988","-","Oct","lastSun",["2","0","0","s"],"60","D"],["1976","1989","-","Mar","Sun>=1",["2","0","0","s"],"0","S"],["1989","only","-","Oct","Sun>=8",["2","0","0","s"],"60","D"],["1990","2006","-","Oct","Sun>=1",["2","0","0","s"],"60","D"],["1990","2007","-","Mar","Sun>=15",["2","0","0","s"],"0","S"],["2007","max","-","Sep","lastSun",["2","0","0","s"],"60","D"],["2008","max","-","Apr","Sun>=1",["2","0","0","s"],"0","S"]]}}';
    tz.transport = function() {
      return json;
    };
    tz.loadZoneJSONData(null, true);
  }
  // On the server we load timezone data at the TIME\_ZONE\_DATA environment variable
  // or 'dist/tz.' We use a synchronous file load to avoid race conditions.
  else {
    tz.loadingScheme = tz.loadingSchemes.PRELOAD_ALL;
    tz.zoneFileBasePath = process.env.TIME_ZONE_DATA ||
      __dirname + '/../../tz';
    tz.transport = function(options) {
      return fs.readFileSync(options.url).toString();
    };
    tz.init({async: false});
  }

  // Duration
  // --------

  // The `time.Duration` class helps keep track of a span of time.
  // Create a new instance of the class, then use the result of `duration.end()`
  // in your logs to get the amount of time elapsed.
  function Duration() {
    this.start = time.now();
  }

  // `end` can return the raw milliseconds elapsed if `render` is set to false.
  // Otherwise it renders that milliseconds number with `time.renderTimespan`.
  Duration.prototype.end = function(render) {
    if (typeof render === 'undefined') {
      render = true;
    }
    this.end = time.now();
    this.result = this.end.getTime() - this.start.getTime();

    if (!render) {
      return this.result;
    }
    return time.renderTimespan(this.result, true);
  };

  var time = {
    moment: moment,
    timezonejs: timezonejs,
    Duration: Duration,

    // Date Formatting
    // --------

    /*
    `easyLong` produces strings like 'Friday July 26 at 8:15am', or
    'Friday July 26 2012 at 8:15am' if the year is different from
    the current year.

    If you pass in a `timezone`, the `date` passed
    in is assumed to be in the _default timezone_.
    */
    easyLong: function(timezone, date) {
      var now = time.now();
      if (!date) {
        date = time.now();
      }
      if (timezone) {
        date = time.toTimezone(date, timezone);
        now = time.toTimezone(now, timezone);
      }
      if (date.getFullYear() === now.getFullYear()) {
        return moment(date).format('dddd MMM D [at] h:mma');
      }
      else {
        return moment(date).format('dddd MMM D YYYY [at] h:mma');
      }
    },

    /*
    `shortDate` produces strings like 'July 1' or 'July 1 2012' if
    the year is different from the current year.

    If you pass in a `timezone`, the `date` passed
    in is assumed to be in the _default timezone_.
    */
    shortDate: function(timezone, date) {
      var now = time.now();
      if (!date) {
        date = time.now();
      }
      if (timezone) {
        date = time.toTimezone(date, timezone);
        now = time.toTimezone(now, timezone);
      }
      if (date.getFullYear() === now.getFullYear()) {
        return moment(date).format('MMM D');
      }
      else {
        return moment(date).format('MMM D YYYY');
      }
    },

    /*
    `dayOfWeek` produces the full, capitalized day of the week.

    If you pass in a `timezone`, the `date` passed
    in is assumed to be in the _default timezone_.
    */
    dayOfWeek: function(timezone, date) {
      if (!date) {
        date = time.now();
      }
      if (timezone) {
        date = time.toTimezone(date, timezone);
      }
      return moment(date).format('dddd');
    },

    /*
    `parse` tries to generate a date from the provided `text`, `timezone`
    and `now` (base time). 'today', 'tomorrow' and 'yesterday' are accepted, and fully
    qualified dates are supported [by Moment](http://momentjs.com/docs/#/parsing/string/).
    If the date cannot be parsed, this method will return `null`.

    If you pass in a `timezone`, the returned date will in the _default timezone_.
    */
    parse: function(text, timezone, now) {
      if (!now) {
        now = time.now();
      }

      if (text.toLowerCase() === 'today') {
        return now;
      }
      else if (text.toLowerCase() === 'tomorrow') {
        return new Date(now.getTime() + time.DAY_IN_MIL);
      }
      else if (text.toLowerCase() === 'yesterday') {
        return new Date(now.getTime() - time.DAY_IN_MIL);
      }

      var momentParsed = moment(text);
      if (momentParsed.isValid()) {
        var result = momentParsed.toDate();
        if (timezone) {
          result = time.fromTimezone(result, timezone);
        }
        return result;
      }
      else {
        return null;
      }
    },

    // `englishTimespan` produces an easily human-readable phrase describing the amount
    // of time described by `mil` milliseconds. It produces basic strings like
    // "30 seconds" or "2 hours", never including anything but the biggest unit.
    // The next step after "1 hour" is "2 hours", nothing in between.
    englishTimespan: function(mil) {
      if (mil < time.SECOND_IN_MIL) {
        return 'now';
      }

      var steps = [
        {divisor: time.SECOND_IN_MIL, single: 'second', plural: 'seconds'},
        {divisor: time.MINUTE_IN_MIL, single: 'minute', plural: 'minutes'},
        {divisor: time.HOUR_IN_MIL, single: 'hour', plural: 'hours'},
        {divisor: time.DAY_IN_MIL, single: 'day', plural: 'days'},
        {divisor: time.WEEK_IN_MIL, single: 'week', plural: 'weeks'},
        {divisor: time.MONTH_IN_MIL, single: 'month', plural: 'months'},
        {divisor: time.DAY_IN_MIL * 365, single: 'year', plural: 'years'}
      ];

      var index = 0;
      var step = function() {
        var units = Math.floor(mil / steps[index].divisor);
        var next = Math.floor(mil / steps[index + 1].divisor);

        if (next > 0) {
          index = index + 1;
          return step();
        }
        else {
          return string.pluralize(units, steps[index].single, steps[index].plural);
        }
      };

      return step();
    },

    // `renderTimespan` formats `mil` milliseconds as a human-readable
    // time string, like ":02.031" (two seconds and 31 milliseconds)
    // or "4:00" (four minutes). Milliseconds will not be shown unless
    // `withMil` is truthy and the timespan is under one minute.
    renderTimespan: function(mil, withMil) {
      var result = '';

      var hours = Math.floor(mil / time.HOUR_IN_MIL);
      if (hours > 0) {
        result += hours;
        result += ':';
      }

      mil -= time.HOUR_IN_MIL * hours;

      var minutes = Math.floor(mil / time.MINUTE_IN_MIL);
      if (hours > 0) {
        result += time.addPadding(minutes, 2);
      }
      else if (minutes > 0) {
        result += minutes;
      }
      mil -= time.MINUTE_IN_MIL * minutes;

      var seconds = Math.floor(mil / time.SECOND_IN_MIL);
      result += ':';
      result += time.addPadding(seconds, 2);

      if (withMil && hours === 0 && minutes === 0) {
        mil -= time.SECOND_IN_MIL * seconds;
        result += '.';
        result += time.addPadding(mil, 3);
      }

      return result;
    },

    // Timezone Manipulation
    // --------

    // `toTimezone` takes a `date` and a `timezone`, converting the provided date
    // to the new timezone from the _default timezone_. Useful in rendering times
    // in the user's timezone on a server.
    toTimezone: function(date, timezone) {
      var source = new timezonejs.Date(date.getTime());
      var target = new timezonejs.Date(date.getTime(), timezone);
      return new Date(date.getTime() +
        (source.getTimezoneOffset() - target.getTimezoneOffset()) * time.MINUTE_IN_MIL);
    },

    // `fromTimezone` takes a `date` and a `timezone`, converting the provided
    // date to the _default timezone_, assuming that `date` was previously in
    // the provided `timezone`.
    fromTimezone: function(date, timezone) {
      var source = new timezonejs.Date(date.getTime(), timezone);
      var target = new timezonejs.Date(date.getTime());
      return new Date(date.getTime() -
        (target.getTimezoneOffset() - source.getTimezoneOffset()) * time.MINUTE_IN_MIL);
    },

    // `timezoneAwareDate` is a wrapper around the instantiation of a new
    // `timezoneJS.Date`.
    timezoneAwareDate: function(date, timezone) {
      return new timezonejs.Date(date.getTime(), timezone);
    },

    /*
    `getTimezone` looks up the current timezone. Because by default PDT/PST will resolve
    to America/Los_Angeles, we put a set of preferred timzones in place, which we look
    through before falling through to the complete list. It uses three approaches:

    1. Attempt to parse timezone signifier out of a date string. The '(PDT)' in
    'Mon Jul 28 2014 18:53:49 GMT-0700 (PDT)'.
    2. Use the timezone offset provided by the browser.
    3. Fall back to 'US/Pacific'
    */
    getTimezone: function() {
      var result;
      var preferred = [
        'US/Pacific',
        'US/Hawaii',
        'US/Aleutian',
        'US/Mountain',
        'US/Central',
        'US/Eastern',
        'Brazil/West',
        'Brazil/East',
        'Europe/London',
        'Europe/Rome',
        'Europe/Istanbul',
        'Asia/Dubai',
        'Asia/Baku',
        'Australia/Sydney',
        'Pacific/Auckland'
      ];
      var zones = this.getTimezones();
      var preferredZones = _.filter(zones, function(zone) {
        return _.contains(preferred, zone.name);
      });

      //first, try to parse out timezone abbreviation
      var now = new Date();
      var string = now.toString();
      var regex = /\((.+)\)/;
      var match = string.match(regex);
      if (match && match[1]) {
        var abbrev = match[1];

        result = _.where(preferredZones, {abbreviation: abbrev});
        if (result && result.length) {
          return result[0].name;
        }

        result = _.where(zones, {abbreviation: abbrev});
        if (result && result.length) {
          return result[0].name;
        }
      }

      //second, use the timezone offset
      var offset = new Date().getTimezoneOffset();

      result = _.where(preferredZones, {rawOffset: offset});
      if (result && result.length) {
        return result[0].name;
      }

      result = _.where(zones, {rawOffset: offset});
      if (result && result.length) {
        return result[0].name;
      }

      //finally, backup - just return the first preferred timezone
      return preferred[0];
    },

    /*
    `getTimezones` returns an array of objects assembled from the list of timezones known
    to timezonejs. Additional processing is done to make each object look like this:

    ```
    {
      abbreviation: "PDT"
      name: "US/Pacific"
      offset: 7
      pretty: "+7 US/Pacific"
      rawOffset: 420
    }
    ```

    Very useful for timezone select boxes.
    */
    getTimezones: function() {
      var zones = tz.getAllZones();
      var now = Date.now();

      return _(zones)
        .map(function(zone) {
          var info = tz.getTzInfo(now, zone, zone === 'UTC');
          var rawOffset = parseInt(info.tzOffset, 10);
          var offset = rawOffset / 60;

          var result = '';
          if (offset > 0) {
            result += '+';
          }

          return {
            pretty: result + offset + ' ' + zone,
            abbreviation: info.tzAbbr,
            name: zone,
            rawOffset: rawOffset,
            offset: offset
          };
        })
        .sortBy('offset')
        .value();
    },

    // Date Manipulation
    // --------

    // `now` returns the current time. Mostly useful to allow for dependency
    // injection while unit testing.
    now: function() {
      return new Date();
    },

    // `offset` just adds `milliseconds` to either the `date` you provide
    // or the current date, and returns a new `Date` object.
    offset: function(milliseconds, date) {
      if (!date) {
        date = time.now();
      }
      var millis = date.getTime() + milliseconds;
      return new Date(millis);
    },

    // `nextDay` looks for the next instance of `day`, where day is something like
    // 'Monday.' You can set the start `date` for the search; otherwise it will use the
    // current time. `timezone` is required to ensure our determination of the day is
    // correct in the user's timezone.
    nextDay: function(day, timezone, date) {
      return this.searchDay(1, day, timezone, date);
    },

    // `lastDay` is exactly like `nextDay`; it just searches in the opposite direction.
    lastDay: function(day, timezone, date) {
      return this.searchDay(-1, day, timezone, date);
    },

    /*
    `searchDay` does the day searching for `nextDay` and `lastDay`.

    _TODO: Think about doing this without basic iteration. Could do it with
    math and indices._
    */
    searchDay: function(direction, day, timezone, date) {
      /*jshint maxcomplexity: 8 */

      if (!time.daysLookup) {
        time.daysLookup = {
          sunday: 0,
          monday: 1,
          tuesday: 2,
          wednesday: 3,
          thursday: 4,
          friday: 5,
          saturday: 6
        };
      }

      if (!date) {
        date = time.now();
      }
      if (timezone) {
        date = new timezonejs.Date(date.getTime(), timezone);
      }

      var index = time.daysLookup[day.toLowerCase()];
      if (!index && index !== 0) {
        return null;
      }

      while (date.getDay() !== index) {
        date = time.offset(direction * time.DAY_IN_MIL, date);
        if (timezone) {
          date = new timezonejs.Date(date.getTime(), timezone);
        }
      }
      if (timezone) {
        date = new Date(date.getTime());
      }

      return date;
    },

    // `toMidnight` returns midnight of the day provided, in the target
    // `timezone`. `date` is optional, but assumed to be in the _default
    // timezone_ if provided.
    toMidnight: function(timezone, date) {
      return time.toHour(0, timezone, date);
    },

    // `toHour` truncates the current time or `date` at hour `hour` in the
    // provided `timezone`. `date` is optional, but assumed to be in the _default
    // timezone_ if provided.
    toHour: function(hour, timezone, date) {
      if (!date) {
        date = time.now();
      }

      date = time.timezoneAwareDate(date, timezone);
      date = new timezonejs.Date(
        date.getFullYear(), date.getMonth(), date.getDate(), hour, timezone
      );
      return new Date(date.getTime());
    },

    // `toFirstOfMonth` returns the date of the first of the current month
    // for now or the provided `date`.`date` is optional, but assumed to be
    // in the _default timezone_ if provided.
    toFirstOfMonth: function(timezone, date) {
      if (!date) {
        date = time.now();
      }
      date = time.timezoneAwareDate(date, timezone);
      date = new timezonejs.Date(date.getFullYear(), date.getMonth(), 1, timezone);

      return new Date(date.getTime());
    },

    // `isLastDayOfMonth` tells you whether it's the last of the current month
    // for now or the provided `date`.`date` is optional, but assumed to be in
    // the _default timezone_ if provided.
    isLastDayOfMonth: function(timezone, date) {
      if (!date) {
        date = time.now();
      }

      var nextDay = new Date(date.valueOf() + time.DAY_IN_MIL);
      nextDay = time.timezoneAwareDate(nextDay, timezone);
      return nextDay.getDate() === 1;
    },

    // Other
    // --------

    /*
    `addPadding` takes an integer and a number of `digits`, adding leading
    zeros to the string until it gets to the desired length.

    _TODO: Doesn't currently handle negative numbers_
    */
    addPadding: function(number, digits) {
      var result = parseInt(number, 10).toString();
      if (result.length >= digits) {
        return result;
      }
      for (var i = result.length + 1; i <= digits; i += 1) {
        result = '0' + result;
      }
      return result;
    }
  };

  // Useful constants
  time.SECOND_IN_MIL = 1000;
  time.MINUTE_IN_MIL = time.SECOND_IN_MIL * 60;
  time.HOUR_IN_MIL = time.MINUTE_IN_MIL * 60;
  time.DAY_IN_MIL = time.HOUR_IN_MIL * 24;
  time.WEEK_IN_MIL = time.DAY_IN_MIL * 7;
  time.MONTH_IN_MIL = time.DAY_IN_MIL * 30;
  time.YEAR_IN_MIL = time.DAY_IN_MIL * 365;

  return time;
});
